# 文件上传（图片/附件）实现方案

> 目标：提供一套最小可用的“文件上传”能力：支持上传图片等文件，保存到服务器指定目录，并返回可访问的 URL；后续可用于 OW 装备/英雄图片等场景。
>
> 技术约束：本项目为本地文件存储（不接 OSS），MySQL 8 + MyBatis-Plus + Sa-Token；不使用 Redis；SQL 手工执行。

## 1. 存储策略（落盘目录）

### 1.1 目录结构

- 配置项：`gm.file.storageDir`（绝对路径或相对路径）
- 建议默认值：`./upload`（项目启动目录下）
- 实际保存路径：`${gm.file.storageDir}/{biz}/{yyyy}/{MM}/{dd}/{uuid}.{ext}`
  - `biz`：业务分组（例如：`ow/item`、`ow/hero`、`user/avatar`）
  - 日期分目录：便于归档与避免单目录文件过多
  - 文件名：UUID（避免重名/覆盖）
  - ext：从原始文件名提取（无 ext 时可根据 content-type 推断，或直接不加）

### 1.2 对外访问（静态资源映射）

由 Spring Boot 提供静态文件访问：

- 访问 URL 前缀：`/files/**`
- 映射：`/files/** -> file:${gm.file.storageDir}/`

上传返回的 `url` 形如：

- `/files/ow/item/2026/01/27/550e8400-e29b-41d4-a716-446655440000.png`

> 说明：生产环境也可以交给 Nginx/CDN 做静态文件分发；后端保持“落盘 + 返回 url”即可。

## 2. 权限与安全策略（最小必需）

### 2.1 权限模型

管理后台上传文件建议要求登录并校验权限点：

- `file:upload`：上传文件

（可选扩展）如要支持删除/列表，可再加：
- `file:list`、`file:delete`

### 2.2 上传校验

最小建议：

- 单文件大小限制：通过 Spring 配置限制（见第 5 节）
- 文件类型限制：
  - 图片：仅允许 `image/*`（png/jpg/jpeg/webp/gif）
  - 其他文件：按需增加白名单（例如 pdf/zip）
- 文件名安全：不使用原始文件名落盘（避免路径穿越/覆盖）；只保留 ext
- `biz` 参数校验：仅允许 `[a-zA-Z0-9/_-]`，禁止 `..` 等穿越

## 3. 接口清单（建议）

### 3.1 上传（管理后台）

- 方法：`POST /api/files/upload`
- 权限：`file:upload`
- Content-Type：`multipart/form-data`
- Form：
  - `file`：文件（必填）
  - `biz`：业务目录（必填，例：`ow/item`）
  - `type`：`image|file`（可选；传 `image` 时强制校验为图片）
- 返回：`data` 为 `FileUploadResponse`
  - `key`：相对路径（用于保存到业务表字段，如 `img_key` 或 `img_url`）
  - `url`：对外访问地址（以 `/files/` 开头）
  - `originalName`：原始文件名
  - `size`：字节
  - `contentType`：MIME

示例返回：

```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "key": "ow/item/2026/01/27/xxx.png",
    "url": "/files/ow/item/2026/01/27/xxx.png",
    "originalName": "a.png",
    "size": 12345,
    "contentType": "image/png"
  }
}
```

### 3.2 直接访问文件（静态）

- 方法：`GET /files/**`
- 鉴权：无（最简单；若未来需要私有文件，可再增加“鉴权下载接口”）

### 3.3 文件列表（管理后台）

- 方法：`GET /api/files`
- 权限：`file:list`
- Query：
  - `page`（默认 1）
  - `size`（默认 20，最大 200）
  - `biz`（可选）
  - `keyword`（可选，匹配 originalName/url）
  - `startAt` / `endAt`（可选，ISO-8601 datetime）
- 返回：分页 `PageResult<SysFileDto>`

### 3.4 删除文件（管理后台）

- 方法：`DELETE /api/files/{id}`
- 权限：`file:delete`
- 行为：
  - DB：标记 `deleted=1` + `deleted_at`
  - 磁盘：尽力删除落盘文件（不存在也视为成功）

## 4. 后端实现落点（按现有模块分层）

### 4.1 代码位置建议

- `gm-api`：Controller
  - `FileController`：`/api/files/upload`
- `gm-file`：文件领域模块（`entity/mapper/service/dto`）
  - `SysFile`/`SysFileMapper`/`FileService`
- `gm-common`：DTO/工具类（通用）
  - `FileStorageProperties` 等
- `gm-config`：Spring 配置
  - `WebMvcConfigurer`：配置 `/files/**` 静态映射（读取 `gm.file.storageDir`）
- 审计（复用现有）
  - 上传成功/失败写入 `sys_audit_log`（action：`FILE_UPLOAD`）

### 4.2 保存逻辑（伪代码）

1) 校验：登录 + `file:upload` + `biz` + 文件大小 + contentType
2) 计算保存路径：
   - `root = storageDir`
   - `sub = biz/yyyy/MM/dd/uuid.ext`
3) `Files.createDirectories(targetDir)`
4) `MultipartFile.transferTo(targetFile)` 或 `Files.copy(inputStream, targetFile)`
5) 返回 `key=sub`，`url=/files/{sub}`

## 5. 配置项（application.yml）

建议新增：

- `gm.file.storageDir: ./upload`
- `spring.servlet.multipart.max-file-size: 10MB`
- `spring.servlet.multipart.max-request-size: 10MB`

## 6. SQL（权限点）

### 6.1 建表脚本（文件元数据）

- `sql/00_schema/V202601271955__create_file_tables.sql`
- 表：`sys_file`
  - 保存上传后的文件元信息（biz、originalName、storagePath、url、size、contentType、createdAt 等）

### 6.2 权限点脚本

- `sql/10_seed/V202601271956__add_admin_file_permissions.sql`
  - `file:upload`、`file:list`、`file:delete`

> 说明：当前系统中 `ADMIN` 角色会被代码视为“拥有全部权限点”，只要权限点存在即可看到菜单/按钮与放行接口。

## 7. 本地验证步骤

1) 执行权限 SQL（第 6 节）后重新登录后台
2) 调用 `POST /api/files/upload`（multipart）上传一张图片
3) 拿到返回的 `url`，在浏览器打开 `http://localhost:{port}{url}` 能看到图片
4) 将返回的 `url` 保存到业务表（例如 `ow_item.img_url`），前台展示优先用 `img_url`，没有再用 `img_key -> imageMap`

管理后台页面验证：

- 页面：`/admin/files`
  - 上传文件、查看列表、复制 URL、删除文件
